# ุฑุงูููุง ฺฉุงูู ุงุณุชูุงุฏู ุงุฒ ุณุณุชู ุชูุตู ูุญุตููุงุช

ุชุงุฑุฎ ุจูโุฑูุฒุฑุณุงู: 2024-10-26

---

## ๐ ููุฑุณุช ูุทุงูุจ

- [๐ ุฎูุงุตู ุชุบุฑุงุช](#ุฎูุงุตู-ุชุบุฑุงุช)
- [๐ ุขูุงุฑ ุฏุชุงุจุณ](#ุขูุงุฑ-ุฏุชุงุจุณ)
- [๐ ูุญูู ุงุณุชูุงุฏู](#ูุญูู-ุงุณุชูุงุฏู)
- [๐ง ุณุงุฎุชุงุฑ ูพุฑูฺู](#ุณุงุฎุชุงุฑ-ูพุฑูฺู)
- [๐ ุณุงุฎุชุงุฑ ูุงู ุฎุฑูุฌ](#ุณุงุฎุชุงุฑ-ูุงู-ุฎุฑูุฌ)
- [๐ ุจุงุฒุขููุฒ ุฏูุฑูโุง](#ุจุงุฒุขููุฒ-ุฏูุฑูโุง)
- [โ ุฑูุน ูุดฺฉูุงุช](#ุฑูุน-ูุดฺฉูุงุช)
- [๐ก ูฺฉุงุช ููู](#ูฺฉุงุช-ููู)
- [๐ง ุงุณุชูุงุฏู ุฏุฑ Laravel](#ุงุณุชูุงุฏู-ุฏุฑ-laravel)

---

## ๐ ุฎูุงุตู ุชุบุฑุงุช

### ุชุบุฑุงุช ุงุนูุงู ุดุฏู ุชุง ุชุงุฑุฎ 2024-10-26

#### 1. ุงุฏุบุงู ู ุญุฐู ูุงูโูุง ุชฺฉุฑุงุฑ

**ุญุฐู test_connection.py**
- **ุฏูู:** ูุงู ูุฏู ู ูุงูุต ุจูุฏ
- **ุฌุงฺฏุฒู:** `test_db_connection.py` ฺฉุงููโุชุฑ ู ุจูุชุฑ ุงุณุช
- **ูุชุฌู:** ฺฉ ูุงู ุชุณุช ูุงุญุฏ ุจุงู ูุงูุฏ

**ูฺฏูโุฏุงุฑ object_loader.py ู dataframe_loader.py**
- **ุฏูู:** ูุฏูุดุงู ูุชูุงูุช ุงุณุช!
- **ุชูุงูุช:**
  - `object_loader.py` โ ุจุฑูโฺฏุฑุฏุงูุฏ `List[User]`, `List[Product]` (object-based)
    - ููุงุณุจ ุจุฑุง: APIุ OOPุ ฺฉุงุฑูุง ุดุกโฺฏุฑุง
  - `dataframe_loader.py` โ ุจุฑูโฺฏุฑุฏุงูุฏ `pl.DataFrame` (dataframe-based)
    - ููุงุณุจ ุจุฑุง: Machine Learningุ ูพุฑุฏุงุฒุด ุฏุงุฏูุ ุชุญูู
- **ุจูุจูุฏ:** `object_loader.py` ุงุฒ `get_engine()` ูุดุชุฑฺฉ ุฏุฑ `dataframe_loader.py` ุงุณุชูุงุฏู ูโฺฉูุฏ
- **ูุชุฌู:** ฺฉุฏ ุชฺฉุฑุงุฑ ฺฉุงูุด ุงูุช

**ุญุฐู run_generate.sh**
- **ุฏูู:** ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ูุณุชููุงู `python generate_recommendations.py` ุฑุง ุงุฌุฑุง ฺฉูุฏ

#### 2. ุงูฺฉุงู Sample Size ุฏุฑ generate_recommendations.py

ุงฺฉููู ูโุชูุงูุฏ ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ุฑุง ูุญุฏูุฏ ฺฉูุฏ:

```bash
# ุชุณุช ุจุง 1000 ฺฉุงุฑุจุฑ (ุชูุตู ูโุดูุฏ)
python generate_recommendations.py --sample 1000

# ุชุณุช ุจุง 100 ฺฉุงุฑุจุฑ
python generate_recommendations.py --sample 100

# ููู ฺฉุงุฑุจุฑุงู (224,959 ฺฉุงุฑุจุฑ)
python generate_recommendations.py --all
python generate_recommendations.py

# ูุดุงูุฏู ุฑุงูููุง
python generate_recommendations.py --help
```

**ูุฒุงุง:**
- ุชุณุช ุณุฑุน ูุจู ุงุฒ ุงุฌุฑุง ฺฉุงูู
- ุจุฑุฑุณ ุนููฺฉุฑุฏ ู ุณุฑุนุช
- ุตุฑููโุฌู ุฏุฑ ุฒูุงู

**ุฒูุงู ุชุฎูู:**
- 100 ฺฉุงุฑุจุฑ โ 30 ุซุงูู
- 1000 ฺฉุงุฑุจุฑ โ 2-5 ุฏููู
- ููู ฺฉุงุฑุจุฑุงู โ 15-45 ุฏููู

#### 3. ุฑูุน ูุดฺฉูุงุช ุฏุชุงุจุณ

- ุญุฐู `deleted_at` ุงุฒ query ุฌุฏูู `users` (ุงู ุณุชูู ูุฌูุฏ ูุฏุงุดุช)
- ุชุบุฑ ููุชุฑ `status = 'published'` ุจู `status = 1` ุจุฑุง ูุญุตููุงุช
- ุงุถุงูู ฺฉุฑุฏู `first_name` ู `last_name` ุจุฑุง ูุงู ฺฉุงุฑุจุฑุงู
- ุฑูุน ูุดฺฉู Polars DataFrame ุจุง ุชุจุฏู SQLAlchemy mappings ุจู dict

---

## ๐ ุขูุงุฑ ุฏุชุงุจุณ ุดูุง

```
โ 224,959 ฺฉุงุฑุจุฑ
โ 36,114 ูุญุตูู ูุนุงู (ุจุง ููุฌูุฏ)
โ 80,737 ุณูุงุฑุด ุชฺฉูู ุดุฏู
โ 299,057 ุขุชู ุณูุงุฑุด
```

---

## ๐ ูุญูู ุงุณุชูุงุฏู

### ูุฑุญูู 1: ุชุณุช ุงุชุตุงู (ุงุฎุชุงุฑ)

```bash
cd /Users/mohammad/Projects/srico/rochi/recommendation
source venv/bin/activate
python test_db_connection.py
```

### ูุฑุญูู 2: ุชููุฏ ุชูุตู ุจุฑุง ฺฉุงุฑุจุฑุงู

#### ฺฏุฒูู A: ุชุณุช ุจุง 1000 ฺฉุงุฑุจุฑ (ุชูุตู ูโุดูุฏ ุจุฑุง ุงููู ุจุงุฑ)

```bash
cd /Users/mohammad/Projects/srico/rochi/recommendation
source venv/bin/activate
python generate_recommendations.py --sample 1000
```

ุงู ุฏุณุชูุฑ ููุท **1000 ฺฉุงุฑุจุฑ ุงูู** ุฑุง ูพุฑุฏุงุฒุด ูโฺฉูุฏ. ููุงุณุจ ุจุฑุง:
- ุชุณุช ุงููู ุณุณุชู
- ุจุฑุฑุณ ุณุฑุนุช ู ุนููฺฉุฑุฏ
- ุตุฑููโุฌู ุฏุฑ ุฒูุงู (ุญุฏูุฏ 2-5 ุฏููู)

#### ฺฏุฒูู B: ุชููุฏ ุจุฑุง ููู ฺฉุงุฑุจุฑุงู (224,959 ฺฉุงุฑุจุฑ)

```bash
python generate_recommendations.py --all
# ุง ุจุฏูู ุขุฑฺฏูููุช
python generate_recommendations.py
```

ุงู ุงุณฺฉุฑูพุช:
1. ฺฉุงุฑุจุฑุงูุ ูุญุตููุงุช ู ุณูุงุฑุดุงุช ุฑุง ุจุงุฑฺฏุฐุงุฑ ูโฺฉูุฏ
2. ูุฏูโูุง Collaborative ู Content-Based ุฑุง ุขููุฒุด ูโุฏูุฏ
3. ุจุฑุง **ููู 224,959 ฺฉุงุฑุจุฑ** ุชูุตู ุชููุฏ ูโฺฉูุฏ (20 ุชูุตู ุจู ุงุฒุง ูุฑ ฺฉุงุฑุจุฑ)
4. ูุชุงุฌ ุฑุง ุฏุฑ ูุงูโูุง ุฒุฑ ุฐุฎุฑู ูโฺฉูุฏ:
   - `storage/app/recommendation/user_recommendations_YYYYMMDD_HHMMSS.parquet`
   - `storage/app/recommendation/user_recommendations_YYYYMMDD_HHMMSS.csv`

**ูฺฉุชู:** ุงู ูุฑุขูุฏ ููฺฉู ุงุณุช 15-45 ุฏููู ุทูู ุจฺฉุดุฏ.

#### ุณุงุฑ ฺฏุฒููโูุง:

```bash
# ุชุณุช ุจุง 100 ฺฉุงุฑุจุฑ (ุฎู ุณุฑุน - ุญุฏูุฏ 30 ุซุงูู)
python generate_recommendations.py --sample 100

# ุชุณุช ุจุง 5000 ฺฉุงุฑุจุฑ
python generate_recommendations.py --sample 5000

# ูุดุงูุฏู ุฑุงูููุง
python generate_recommendations.py --help
```

### ูุฑุญูู 3: ุจุฑุฑุณ ูุชุงุฌ

ุจุนุฏ ุงุฒ ุงุชูุงูุ ูโุชูุงูุฏ ูุชุงุฌ ุฑุง ุจุฑุฑุณ ฺฉูุฏ:

```bash
# ููุงุด ูุงูโูุง ุงุฌุงุฏ ุดุฏู
ls -lh storage/app/recommendation/user_recommendations_*

# ูุดุงูุฏู ฺูุฏ ุฎุท ุงูู CSV
head -20 storage/app/recommendation/user_recommendations_*.csv

# ุง ุจุง Python
python -c "
import polars as pl
df = pl.read_csv('storage/app/recommendation/user_recommendations_*.csv')
print(f'ุชุนุฏุงุฏ ฺฉู ุชูุตูโูุง: {len(df)}')
print(f'ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู: {df[\"user_id\"].n_unique()}')
print(df.head(20))
"
```

### ูุฑุญูู 4: ุงุณุชูุงุฏู ุงุฒ API (ุงุฎุชุงุฑ)

ุงฺฏุฑ ูโุฎูุงูุฏ ุงุฒ API ุงุณุชูุงุฏู ฺฉูุฏ:

```bash
python run_recommendation.py api --host 0.0.0.0 --port 8000
```

ุณูพุณ ูโุชูุงูุฏ ุจู ุขุฏุฑุณ ุฒุฑ ุจุฑูุฏ:
- ๐ http://localhost:8000/docs (ูุณุชูุฏุงุช Swagger)
- ๐ http://localhost:8000/recommendations/123 (ุชูุตู ุจุฑุง ฺฉุงุฑุจุฑ 123)

---

## ๐ง ุณุงุฎุชุงุฑ ูพุฑูฺู

### ูุงูโูุง ุงุตู:

```
recommendation/
โโโ generate_recommendations.py    โญ ุงุณฺฉุฑูพุช ุงุตู (ุจุง ูุงุจูุช --sample)
โโโ test_db_connection.py          โ ุชุณุช ุงุชุตุงู
โโโ object_loader.py               โ ุจุงุฑฺฏุฐุงุฑ object-based
โโโ dataframe_loader.py            โ ุจุงุฑฺฏุฐุงุฑ dataframe-based
โโโ collaborative_filtering.py     โ ุงูฺฏูุฑุชู CF
โโโ content_based_filtering.py     โ ุงูฺฏูุฑุชู CBF
โโโ hybrid_recommender.py          โ ุณุณุชู ุชุฑฺฉุจ
โโโ recommendation_api.py          โ FastAPI ุณุฑูุฑ
โโโ run_recommendation.py          โ CLI
โโโ models.py                      โ ูุฏูโูุง ุฏุงุฏู
โโโ settings.py                    โ ุชูุธูุงุช
โโโ pipeline.py                    โ ูพุงูพูุงู Matomo
โโโ matomo_client.py              โ ฺฉูุงูุช Matomo
โโโ README.md                      โ ุงู ูุงู (ูุณุชูุฏุงุช ฺฉุงูู)
```

### ูุงูโูุง ุญุฐู ุดุฏู:
- `test_connection.py` (ูุฏู)
- `run_generate.sh` (ุบุฑุถุฑูุฑ)

---

## ๐ ุณุงุฎุชุงุฑ ูุงู ุฎุฑูุฌ

ูุงู CSV ุดุงูู ุณุชููโูุง ุฒุฑ ุงุณุช:

| ุณุชูู | ุชูุถุญ |
|------|-------|
| `user_id` | ุดูุงุณู ฺฉุงุฑุจุฑ |
| `product_id` | ุดูุงุณู ูุญุตูู ุชูุตู ุดุฏู |
| `score` | ุงูุชุงุฒ ุชูุตู (ูุฑฺู ุจุงูุงุชุฑุ ุจูุชุฑ) |
| `rank` | ุฑุชุจู ุชูุตู (1 = ุจูุชุฑู) |
| `confidence` | ูุฒุงู ุงุทููุงู (0-1) |
| `reason` | ุฏูู ุชูุตู |
| `generated_at` | ุฒูุงู ุชููุฏ ุชูุตู |

---

## ๐ ุจุงุฒุขููุฒ ุฏูุฑูโุง

ุชูุตู ูโุดูุฏ ุงู ุงุณฺฉุฑูพุช ุฑุง ุจู ุตูุฑุช ุฏูุฑูโุง (ูุซูุงู ููุชฺฏ) ุงุฌุฑุง ฺฉูุฏ:

```bash
# ุงุถุงูู ฺฉุฑุฏู ุจู crontab ุจุฑุง ุงุฌุฑุง ููุชฺฏ (ูุฑ ุดูุจู ุณุงุนุช 2 ุตุจุญ)
0 2 * * 6 cd /Users/mohammad/Projects/srico/rochi/recommendation && source venv/bin/activate && python generate_recommendations.py >> logs/recommendations.log 2>&1
```

---

## โ ุฑูุน ูุดฺฉูุงุช

### ูุดฺฉู: "KeyError: 'order_user_id'"
โ **ุญู ุดุฏ** - ูุดฺฉู Polars DataFrame ุฑูุน ุดุฏ

### ูุดฺฉู: "Unknown column 'deleted_at' in WHERE"
โ **ุญู ุดุฏ** - queryโูุง ุฏุชุงุจุณ ุงุตูุงุญ ุดุฏูุฏ

### ูุดฺฉู: "ูฺ ุชูุตูโุง ุชููุฏ ูุดุฏ"
ุงุญุชูุงูุงู:
- ุชุนุฏุงุฏ ุณูุงุฑุดุงุช ฺฉุงู ูุณุช (ุญุฏุงูู 100 ุณูุงุฑุด ูุงุฒ ุงุณุช)
- ุจุงุฒู ุฒูุงู ุฎู ฺฉูุชุงู ุงุณุช
- ฺฉุงุฑุจุฑุงู ุณูุงุฑุด ุซุจุช ูฺฉุฑุฏูโุงูุฏ

**ุฑุงู ุญู:** ุงุณฺฉุฑูพุช ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุจุงุฒู ุฒูุงู ุฑุง ุงูุฒุงุด ูโุฏูุฏ

### ูุดฺฉู: ูุฑุขูุฏ ุฎู ฺฉูุฏ ุงุณุช
ุฏูุงู ุงุญุชูุงู:
- ุชุนุฏุงุฏ ุฒุงุฏ ฺฉุงุฑุจุฑุงู (224K ฺฉุงุฑุจุฑ)
- ุชุนุฏุงุฏ ุฒุงุฏ ูุญุตููุงุช (36K ูุญุตูู)
- ูุญุงุณุจุงุช ูุงุชุฑุณ ุดุจุงูุช

**ุฑุงู ุญู:**
- ุตุจุฑ ฺฉูุฏ (10-30 ุฏููู)
- ุง ูโุชูุงูุฏ ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ุฑุง ุจุง `--sample` ูุญุฏูุฏ ฺฉูุฏ

---

## ๐ก ูฺฉุงุช ููู

1. **ุชูุตู ุดุฏุฏ:** ุจุฑุง ุงููู ุจุงุฑ ุจุง `--sample 1000` ุดุฑูุน ฺฉูุฏ
2. ุฏุชุงุจุณ ุดูุง **224,959 ฺฉุงุฑุจุฑ** ุฏุงุฑุฏ - ูพุฑุฏุงุฒุด ฺฉุงูู ุฒูุงูโุจุฑ ุงุณุช
3. ุณุณุชู ููุท **ูุญุตููุงุช ูุนุงู ุจุง ููุฌูุฏ** ุฑุง ุชูุตู ูโฺฉูุฏ
4. ุณุณุชู ูุญุตููุงุช ฺฉู ฺฉุงุฑุจุฑ ูุจูุงู ุฎุฑุฏู ุฑุง ุชูุตู ููโฺฉูุฏ
5. ูุงู CSV ุฑุง ูโุชูุงูุฏ ุจู ุฑุงุญุช ุฏุฑ Laravel ุจุฎูุงูุฏ ู ุงุณุชูุงุฏู ฺฉูุฏ
6. ุฒูุงู ุชุฎูู: 100 ฺฉุงุฑุจุฑ โ 30 ุซุงููุ 1000 ฺฉุงุฑุจุฑ โ 3-5 ุฏูููุ ููู ฺฉุงุฑุจุฑุงู โ 15-45 ุฏููู

---

## ๐ง ุงุณุชูุงุฏู ุฏุฑ Laravel

```php
<?php
use Illuminate\Support\Facades\DB;

// ุฎูุงูุฏู ุชูุตูโูุง ุจุฑุง ฺฉ ฺฉุงุฑุจุฑ
$userId = 123;
$csv = storage_path('app/recommendation/user_recommendations_latest.csv');

$recommendations = collect(array_map('str_getcsv', file($csv)))
    ->slice(1) // ุญุฐู header
    ->map(function ($row) {
        return [
            'user_id' => $row[0],
            'product_id' => $row[1],
            'score' => $row[2],
            'rank' => $row[3],
            'confidence' => $row[4],
            'reason' => $row[5],
        ];
    })
    ->where('user_id', $userId)
    ->take(10);

// ุง import ฺฉุฑุฏู ุจู ุฌุฏูู MySQL
// CREATE TABLE user_recommendations (
//     user_id BIGINT,
//     product_id BIGINT,
//     score FLOAT,
//     rank INT,
//     confidence FLOAT,
//     reason TEXT,
//     generated_at TIMESTAMP,
//     INDEX(user_id)
// );
```

---

## ๐ฏ ูุฑุงุญู ุจุนุฏ

1. ุงุฌุฑุง ุชุณุช: `python generate_recommendations.py --sample 1000`
2. ุจุฑุฑุณ ูุงู CSV ุฎุฑูุฌ
3. ุงฺฏุฑ ูุชุฌู ููุงุณุจ ุจูุฏุ ุงุฌุฑุง ฺฉุงูู: `python generate_recommendations.py --all`
4. ุงุณุชูุงุฏู ุงุฒ ุชูุตูโูุง ุฏุฑ Laravel
5. ููุงุด ุชูุตูโูุง ุจู ฺฉุงุฑุจุฑุงู
6. ุชูุธู cron job ุจุฑุง ุจุงุฒุขููุฒ ุฏูุฑูโุง

---

**ูููู ุจุงุดุฏ! ๐**
